# Repository Guidelines

## Project Overview
Track Planner is a browser-based H0 model railway track planning application built with React 19, TypeScript, and Vite. It provides a canvas-based interface for designing track layouts using predefined track component libraries (e.g., PIKO A-Gleis H0), with features for multi-project management, component placement, endpoint connection, and SVG export.

## Project Structure & Module Organization

### Core Directories
- **`src/`** – Main application source code:
  - **`main.tsx`** – React entry point with StrictMode
  - **`App.tsx`** – Root component orchestrating layout, state, and user interactions
  - **`components/Layout/`** – UI components:
    - `Canvas.tsx` – Interactive SVG canvas with pan/zoom, drag-drop, selection, and endpoint connection
    - `ComponentsSidebar.tsx` – Right sidebar displaying available track components for drag-drop
    - `ProjectsSidebar.tsx` – Left sidebar for project management (create, rename, delete, select)
    - `TopToolbar.tsx` – Top toolbar with project actions and item manipulation controls
  - **`state/`** – State management:
    - `projectsState.ts` – Custom hook (`useProjectsState`) managing multi-project state with localStorage persistence
    - `layoutState.ts` – Factory functions for creating default layout states
  - **`types/`** – TypeScript type definitions:
    - `project.ts` – Project interface and factory functions
    - `layout.ts` – Layout state, placed items, and endpoint connections
    - `trackSystem.ts` – Track system definitions, component types, connectors, and geometry interfaces
  - **`geometry/`** – Track geometry calculations:
    - `trackGeometry.ts` – Component geometry generation (straight, curve, switch variants), coordinate transformations, angle normalization
    - `trackEndpoint.ts` – Endpoint pose calculations and connection transform computation
  - **`export/`** – Export functionality:
    - `exportSvg.ts` – SVG string generation from layout state with bounds calculation
  - **`hooks/`** – Custom React hooks:
    - `useLocalStorageState.ts` – Generic hook for localStorage-backed state with SSR safety
  - **`constants/`** – Application constants:
    - `layout.ts` – Rotation step degrees and other layout constants
  - **`data/`** – Track system definitions:
    - `pikoA_H0.ts` – PIKO A-Gleis H0 track system with component catalog
    - `demoTrackSystem.json` – Demo track system data (if present)
  - **`styles/`** – Additional stylesheets (currently empty)
  - **`index.css`** – Global styles with Tailwind imports and root CSS variables

- **`public/`** – Static assets (vite.svg, manifest files) copied as-is to build output
- **`dist/`** – Production build output (generated by `npm run build`; do not commit)
- **Root config files** – `tsconfig.*.json`, `vite.config.ts`, `tailwind.config.js`, `eslint.config.js`

## Technology Stack

### Core Dependencies
- **React 19.2.0** – UI framework with latest features
- **TypeScript 5.9.3** – Type safety and developer experience
- **Vite 7.2.2** – Build tool and dev server with HMR
- **Tailwind CSS 4.0.0-alpha.14** – Utility-first CSS via `@tailwindcss/vite` plugin

### Development Dependencies
- **ESLint 9.39.1** – Linting with flat config
- **TypeScript ESLint 8.46.3** – TypeScript-aware linting rules
- **ESLint React plugins** – React hooks and refresh rules
- **Prettier 3.1.1** – Code formatting (via ESLint config)
- **@vitejs/plugin-react-swc 4.2.1** – Fast React refresh using SWC

## Build, Test, and Development Commands
- **`npm install`** – Installs pinned dependencies (React 19, Vite, Tailwind v4 alpha, TypeScript, ESLint tooling)
- **`npm run dev`** – Starts Vite dev server with HMR, Tailwind preprocessing, and hot module replacement
- **`npm run build`** – Runs `tsc -b` for type checking, then `vite build` to emit optimized production bundle in `dist/`
- **`npm run preview`** – Serves the production bundle locally for verification before deployment
- **`npm run lint`** – Runs ESLint (flat config) with TypeScript, React hooks, React refresh, and Prettier rules

## Architecture Patterns

### State Management
- **Custom hooks pattern**: `useProjectsState()` manages project list, active project, and layout updates
- **localStorage persistence**: `useLocalStorageState()` hook automatically syncs state to browser storage
- **Immutable updates**: State updates use functional updaters to maintain immutability
- **State structure**: Projects contain layouts; layouts contain track systems, placed items, and connections

### Component Architecture
- **Layout components**: Three-panel layout (ProjectsSidebar | Canvas | ComponentsSidebar) with TopToolbar
- **Canvas interaction**: Forward ref pattern (`CanvasHandle`) for imperative operations (rotate, delete, connect)
- **Event handling**: Pointer events for drag-drop, selection, panning; keyboard shortcuts (R/Shift+R for rotation, Delete/Backspace, Escape)
- **Geometry system**: Component definitions → geometry calculations → SVG path rendering with connector endpoints

### Key Features
- **Multi-project support**: Create, rename, delete projects with localStorage persistence
- **Track component library**: Drag-drop components from sidebar to canvas
- **Interactive canvas**: Pan (drag background), zoom (mouse wheel), select items, drag items with snap-to-endpoint
- **Endpoint connection**: Select two endpoints (Shift-click for additive selection), connect to align and join tracks
- **Item manipulation**: Rotate selected items (15° steps, toolbar buttons or R/Shift+R), delete selected items
- **SVG export**: Export layout as SVG file with proper bounds calculation
- **Connection constraints**: Connected items cannot be rotated or moved (prevents breaking connections)

## Coding Style & Naming Conventions

### Naming
- **Components**: PascalCase (e.g., `Canvas`, `ComponentsSidebar`, `TrackSystemDefinition`)
- **Functions/props**: camelCase (e.g., `handleComponentClick`, `onUpdateLayout`)
- **Custom hooks**: `use` prefix (e.g., `useProjectsState`, `useLocalStorageState`)
- **Constants**: SCREAMING_SNAKE_CASE in `src/constants/` or `src/data/` (e.g., `ROTATION_STEP_DEG`)
- **Types/interfaces**: PascalCase (e.g., `LayoutState`, `PlacedItem`, `TrackComponentDefinition`)

### Code Style
- **Indentation**: Two spaces
- **Quotes**: Single quotes for strings (Prettier handles this)
- **Formatting**: Prettier defaults; avoid formatting-only changes unless necessary
- **Tailwind classes**: Group by layout → spacing → colors for readability
- **TypeScript**: Strict mode enabled; prefer interfaces for object shapes, types for unions/primitives
- **React patterns**: Functional components with hooks; `forwardRef` for imperative handles; `useCallback`/`useMemo` for performance

### File Organization
- One component per file (matching filename to export)
- Co-locate related types with their usage when appropriate
- Group imports: external → internal, types → values

## Geometry System

### Component Types
- **Straight**: Linear track segments with configurable length
- **Curve**: Arc segments with radius, angle, and clockwise/anticlockwise direction
- **Switch**: Multiple variants:
  - Simple switch (straight + diverging branch)
  - Curved switch (inner/outer radius arcs)
  - Three-way switch (main + left/right branches)
  - Y-switch (stub + symmetric branches)
  - Double slip (crossing with slip connections)

### Geometry Calculations
- **Connectors**: Each component defines `start`, `end`, and optional `extraConnectors` (e.g., `branch`, `diverging`)
- **Transformations**: Local connector coordinates → world coordinates via rotation and translation
- **Snapping**: Items snap to endpoints when within `SNAP_DISTANCE_MM` (8mm) and angle tolerance (15°)
- **Connection**: Computes transform to align two endpoints (opposite directions, position alignment)

## Testing Guidelines
There is no automated test suite yet. The current safety net is:
- **Type checking**: `tsc -b` during build catches type errors
- **Linting**: ESLint with TypeScript rules catches common issues
- **Manual verification**: Test in `npm run dev` for interactive features

When adding logic:
- Verify behavior manually in the dev environment
- Test edge cases (empty projects, deleted items, connection constraints)
- Future tests should live in `tests/` or `src/__tests__/` with naming pattern `*.test.ts[x]`

## Commit & Pull Request Guidelines
- **Commit messages**: Short, imperative summaries (~50 characters), with body for context when needed
- **PR descriptions**: Explain the change, link issues (e.g., `Fixes #123`), attach screenshots for UI changes
- **Pre-commit checks**: Run `npm run lint` and `npm run build` before opening PRs
- **Verification**: Reference manual testing steps performed (e.g., "Tested drag-drop, endpoint connection, SVG export")

## Known Limitations & Future Work
- Import functionality is stubbed (not yet implemented)
- Multiple track systems per layout not yet supported (single active system per layout)
- Elevation/layer/wiring overlays not yet implemented (see TODOs in Canvas.tsx)
- No undo/redo functionality
- No grid snapping (only endpoint snapping)
- Component library limited to PIKO A-Gleis H0 (extensible via `TrackSystemDefinition`)
